name: Deploy

on:
  push:
    tags:
      - "v*"

# Deploy on github available runners: https://docs.github.com/en/actions/reference/runners/github-hosted-runners

jobs:
  check_version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Check deployed version
        run: |
          [ "$GITHUB_REF_NAME" == "v$(uv version --short)" ]
  tests:
    needs: check_version
    uses: ./.github/workflows/tests.yml
  deploy-pypi:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Build package
        run: uv build
      - name: Publish package  # Could use uv publish instead?
        uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
  build-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        python-version: ["3.10"]
    needs: tests
    steps:
      - uses: actions/checkout@v6
      - name: Install uv and set the Python version
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install the project
        run: uv sync --locked --all-extras --dev
      - name: Create artifacts
        run: |
          cd deploy/linux
          bash build.sh
          mv dist/BOOM BOOM-${{ matrix.os }}
          mv boom_$(uv version --short)-1_all.deb "boom_$(uv version --short)-1_all (${{ matrix.os }}).deb"
      - name: Upload artifacts for linux
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.os }}-artifacts
          retention-days: 2
          path: |
            deploy/linux/BOOM-${{ matrix.os }}
            deploy/linux/boom*.deb
  build-macos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-14, macos-15, macos-15-intel]
        python-version: ["3.10"]
    needs: tests
    steps:
      - uses: actions/checkout@v6
      - name: Install uv and set the Python version
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install the project
        run: uv sync --locked --all-extras --dev
      - name: Create artifacts
        run: |
          cd deploy/macos
          uv run pyinstaller BOOM.spec
          mv dist/BOOM.app BOOM-${{ matrix.os }}.app
          zip -r BOOM-${{ matrix.os }}.app.zip BOOM-${{ matrix.os }}.app
      - name: Upload artifacts for macos
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.os }}-artifacts
          retention-days: 2
          path: deploy/macos/BOOM-${{ matrix.os }}.app.zip
  build-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2022, windows-2025, windows-11-arm]
        python-version: ["3.10"]
    needs: tests
    steps:
      - uses: actions/checkout@v6
      - name: Install uv and set the Python version
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install the project
        run: uv sync --locked --all-extras --dev
      - name: Create artifacts
        run: |
          cd deploy/windows
          uv run pyinstaller BOOM.spec
          mv dist/BOOM.exe BOOM-${{ matrix.os }}.exe
      - name: Upload artifacts for windows
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.os }}-artifacts
          retention-days: 2
          path: deploy/windows/BOOM-${{ matrix.os }}.exe
  build-web:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v6
      - name: Install uv and set the Python version
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install the project
        run: uv sync --locked --all-extras --dev
      - name: Build
        run: |
          cd deploy/web
          bash build.sh
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy/web/build/web # The folder the action should deploy.
  create-gh-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
      - name: Release ${{github.ref_name}}
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            *-artifacts/*
